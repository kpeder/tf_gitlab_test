image: ruby:2.1

before_script:
  - apt-get update && apt-get install -y unzip
  - wget https://releases.hashicorp.com/terraform/0.10.7/terraform_0.10.7_linux_amd64.zip -O /tmp/terraform.zip
  - mkdir -p /opt/terraform/bin
  - unzip -d /opt/terraform/bin /tmp/terraform.zip
  - ln -s /opt/terraform/bin/terraform /usr/bin/terraform
  - rm /tmp/terraform.zip

deploy_ci_env:
  script:
  - eval $(ssh-agent -s)
  - echo "${PROVISIONER_KEY}" | ssh-add -
  - cat <<HERE >remote_state.tf \
    terraform { \
      backend "s3" { \
        bucket  = "my-tf-state-files" \
        key     = "tf_gitlab_test/ci-state.tfstate" \
        region  = "us-west-2" \
        profile = "pederson" \
      } \
    } \
    HERE
  - terraform init
  - terraform plan
  only:
  - master
